<!DOCTYPE html>
<html>
<head>
    <title>Sophia Chat</title>
    <meta charset="UTF-8">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        #chat-box { 
            height: 400px; 
            border: 2px solid #0066cc; 
            overflow-y: auto; 
            padding: 15px; 
            background: #f9f9f9;
            margin-bottom: 10px;
        }
        #message-input { 
            width: 80%; 
            padding: 10px; 
            font-size: 14px;
        }
        button {
            padding: 10px 20px;
            font-size: 14px;
            background: #0066cc;
            color: white;
            border: none;
            cursor: pointer;
        }
        button:hover { background: #0052a3; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .user-msg { color: #000; margin: 5px 0; }
        .sophia-msg { color: #0066cc; margin: 5px 0; font-weight: 500; }
        .system-msg { color: #666; font-style: italic; margin: 5px 0; font-size: 12px; }
        .error-msg { color: #cc0000; font-weight: bold; margin: 5px 0; }
    </style>
</head>
<body>
    <h1>Sophia Chat</h1>
    <div id="status" class="system-msg">Connecting...</div>
    <div id="chat-box"></div>
    <input type="text" id="message-input" placeholder="Type your message..." disabled/>
    <button id="send-btn" onclick="sendMessage()" disabled>Send</button>
    
    <script>
        const chatBox = document.getElementById("chat-box");
        const messageInput = document.getElementById("message-input");
        const sendBtn = document.getElementById("send-btn");
        const statusDiv = document.getElementById("status");
        const sessionId = "session_" + Math.random().toString(36).substr(2, 9);

        console.log("Initializing WebSocket with session:", sessionId);

        // Use current hostname for WebSocket connection
        const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsHost = window.location.host;
        const wsUrl = `${wsProtocol}//${wsHost}/ws/${sessionId}`;
        
        console.log("WebSocket URL:", wsUrl);
        
        let ws;
        let wsReady = false;

        function connect() {
            try {
                ws = new WebSocket(wsUrl);

                ws.onopen = function() {
                    wsReady = true;
                    messageInput.disabled = false;
                    sendBtn.disabled = false;
                    statusDiv.textContent = "✓ Connected to Sophia";
                    statusDiv.className = "system-msg";
                    console.log("WebSocket connected successfully");
                    addSystemMessage("Connected to Sophia ✓");
                };

                ws.onmessage = function(event) {
                    console.log("Received:", event.data);
                    addSophiaMessage(event.data);
                };

                ws.onerror = function(error) {
                    console.error("WebSocket error:", error);
                    statusDiv.textContent = "✗ Connection Error";
                    statusDiv.className = "error-msg";
                    addErrorMessage("Connection error occurred");
                };

                ws.onclose = function(event) {
                    wsReady = false;
                    messageInput.disabled = true;
                    sendBtn.disabled = true;
                    statusDiv.textContent = "✗ Disconnected";
                    statusDiv.className = "error-msg";
                    console.log("WebSocket closed:", event.code, event.reason);
                    addErrorMessage("Disconnected from Sophia");
                };
            } catch (e) {
                console.error("Failed to create WebSocket:", e);
                addErrorMessage("Failed to connect: " + e.message);
            }
        }

        function addSystemMessage(text) {
            const msg = document.createElement("p");
            msg.className = "system-msg";
            msg.textContent = text;
            chatBox.appendChild(msg);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function addErrorMessage(text) {
            const msg = document.createElement("p");
            msg.className = "error-msg";
            msg.textContent = "ERROR: " + text;
            chatBox.appendChild(msg);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function addUserMessage(text) {
            const msg = document.createElement("p");
            msg.className = "user-msg";
            msg.textContent = "You: " + text;
            chatBox.appendChild(msg);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function addSophiaMessage(text) {
            const msg = document.createElement("p");
            msg.className = "sophia-msg";
            msg.textContent = "Sophia: " + text;
            chatBox.appendChild(msg);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function sendMessage() {
            const message = messageInput.value.trim();
            if (message && wsReady) {
                console.log("Sending:", message);
                ws.send(message);
                addUserMessage(message);
                messageInput.value = "";
            } else if (!wsReady) {
                addErrorMessage("Not connected. Please refresh the page.");
            }
        }

        messageInput.addEventListener("keyup", function(event) {
            if (event.key === "Enter") {
                sendMessage();
            }
        });

        // Start connection
        connect();
    </script>
</body>
</html>
